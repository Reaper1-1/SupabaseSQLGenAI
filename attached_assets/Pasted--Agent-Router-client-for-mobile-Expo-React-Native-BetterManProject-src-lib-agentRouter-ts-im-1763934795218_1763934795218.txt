// Agent Router client for mobile (Expo/React Native)
// BetterManProject/src/lib/agentRouter.ts

import { supabase } from "./supabaseClient"; 
import { AgentId } from "../constants/agents"; 

// --- Configuration ---
// Assuming you use the Expo config pattern for environment variables:
// AGENT_ROUTER_URL is read from the .env file generated by build-version.js
const AGENT_ROUTER_URL = process.env.SUPABASE_FUNCTION_URL ?? "https://<YOUR_SUPABASE_PROJECT_REF>.functions.supabase.co/agent-router";

// --- Types must match your edge function ---
export interface AgentRouterRequest {
  agentId: AgentId;
  message: string;
  context?: Record<string, unknown>;
  metadata?: Record<string, unknown>;
}

export interface AgentRouterResponse {
  ok: boolean;
  agent_id: AgentId;
  reply: string;
  error?: string;
  details?: string;
}

/**
 * Calls the Supabase edge function `agent-router`.
 * Automatically:
 * - fetches current user via Supabase Auth
 * - attaches user_id, agent_id, message, context, metadata
 */
export async function callAgentRouter(
  payload: AgentRouterRequest,
): Promise<AgentRouterResponse> {
  
  if (!AGENT_ROUTER_URL || AGENT_ROUTER_URL.includes("<YOUR_SUPABASE_PROJECT_REF>")) {
    throw new Error(
      "AGENT_ROUTER_URL not configured. Set SUPABASE_FUNCTION_URL in your .env file.",
    );
  }

  // Get authenticated user from Supabase (using mock for demonstration)
  const {
    data: { user },
    error: authError,
  } = await supabase.auth.getUser();

  if (authError) {
    console.error("Supabase auth error:", authError);
    throw new Error("Failed to get authenticated user");
  }

  if (!user) {
    throw new Error("User not authenticated");
  }

  const body = {
    user_id: user.id,
    agent_id: payload.agentId,
    message: payload.message,
    context: payload.context ?? {},
    metadata: payload.metadata ?? {},
  };

  const res = await fetch(AGENT_ROUTER_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      // Include authorization token here if using RLS
      // Authorization: `Bearer ${user.session.access_token}` 
    },
    body: JSON.stringify(body),
  });

  let json: AgentRouterResponse;
  try {
    json = (await res.json()) as AgentRouterResponse;
  } catch (e) {
    console.error("Failed to parse agent-router response", e);
    throw new Error("Invalid response from agent router");
  }

  if (!res.ok || !json.ok) {
    console.error("Agent router error:", json);
    throw new Error(json.error || "Agent router call failed");
  }

  return json;
}

